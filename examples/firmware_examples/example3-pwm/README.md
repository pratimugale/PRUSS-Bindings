# PWM Example

The code to be demonstrated is in `pwm-assembly/` directory.
**Note**: `archive-pwm-c/` demonstrates pwm generation in C but is not in use as the frequency cannot be accurately determined without using assembly.
It is the example from the PRU Cookbooki.

## Installation
1. `cd pwm-assembly`
2. `make`
The Makefile will do all the work, compile the user space program and run it.

**Note**
1. Make sure that the proper symbolic links have been made for `clpru` and `lnkpru`. 
2. uncomment `disable_uboot_overlay_video=1` in `/boot/uEnv.txt`: for config-pin.
3. Give appropriate path the PRU_CGT env variable in the Makefiles.

## Working, Communication Scheme.
The PWM signal is generated by the PRU0 on P9_31 GPIO which is controlled by the LSB of R30 as seen in the assembly code. The PRU1 firmware uses the RPMsg framework to input two 4-byte integers from the userspace program and then stores it into the PRU SRAM to be read by PRU0. The integers represent the cycles for which the PRU must be ON(divided by 2) and the total cycles(divided by 2). The division by 2 is because there are two instructions which execute after the GPIO is set or cleared inside the loop.

 The on cycles and total cycles are calculated by the userspace program which takes frequency and duty cycle as its input. At the fastest frequency, the duty cycle is accurate up to 2 decimal places. Hence, the total PRU cycles at the fastest frequency is 100 * 2. Hence, theoretically, the fastest PWM frequency is (1/(100 * 2 * 5ns)) = 1MHz. This frequency can then be adjusted from 1 Hz to 1MHz by the userspace cpp program. There is also a lower limit on frequency because the total number of cycles will become too large to be stored in 4 bytes of memory.

 The on cycles are stored from 0x00010000 to 0x00010003 and the total cycles are stored from 0x00010004 to 0x00010007 i.e. in the PRU SRAM. Each address location of the PRU memory can store 1 byte of data.

Frequency, Duty Cycle input -> UserSpace Program -> cpp-bindings -> Python Daemon Service -> rpmsg_pru31 channel -> PRU1 writes the data -> PRU0 reads the data and starts functioning.

The Python Daemon and cpp-bindings are explained in detail in the main Documentation.


